version: '3.8'

services:
  # IAM
  keycloak:
    build:
      context: ./keycloak
      dockerfile: Dockerfile
    container_name: keycloak
    restart: always
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak_postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
    command: start-dev --import-realm
    ports:
      - "8180:8080"
    depends_on:
      - keycloak_postgres
    networks:
      - zta-network

  keycloak_postgres:
    image: postgres:16-alpine
    container_name: keycloak_postgres
    restart: always
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - zta-network

  # Policy Engine (OPA)
  opa:
    image: openpolicyagent/opa:0.60.0-envoy
    container_name: opa
    command:
      - "run"
      - "--server"
      - "--log-level=debug"
      - "--set=plugins.envoy_ext_authz_grpc.addr=:9191"
      - "--set=plugins.envoy_ext_authz_grpc.path=envoy/authz/allow"
      - "--set=decision_logs.console=true"
    ports:
      - "8181:8181"
      - "9191:9191"
    networks:
      - zta-network

  # Service 1: Go Service (with Envoy sidecar)
  go-service:
    build:
      context: ./services/go-service
      dockerfile: Dockerfile
    container_name: go-service
    environment:
      SERVICE_NAME: go-service
      SERVICE_PORT: 8080
    networks:
      - zta-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  go-service-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile.go-service
    container_name: go-service-envoy
    ports:
      - "9001:8000"
    networks:
      - zta-network
    depends_on:
      - go-service
      - opa
      - keycloak

  # Service 2: Python Service (with Envoy sidecar)
  python-service:
    build:
      context: ./services/python-service
      dockerfile: Dockerfile
    container_name: python-service
    environment:
      SERVICE_NAME: python-service
      SERVICE_PORT: 8080
    networks:
      - zta-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  python-service-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile.python-service
    container_name: python-service-envoy
    ports:
      - "9002:8000"
    networks:
      - zta-network
    depends_on:
      - python-service
      - opa
      - keycloak

  # Service 3: C# Service (with Envoy sidecar)
  csharp-service:
    build:
      context: ./services/csharp-service
      dockerfile: Dockerfile
    container_name: csharp-service
    environment:
      SERVICE_NAME: csharp-service
      ASPNETCORE_URLS: http://+:8080
    networks:
      - zta-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3

  csharp-service-envoy:
    build:
      context: ./envoy
      dockerfile: Dockerfile.csharp-service
    container_name: csharp-service-envoy
    ports:
      - "9003:8000"
    networks:
      - zta-network
    depends_on:
      - csharp-service
      - opa
      - keycloak

networks:
  zta-network:
    driver: bridge

volumes:
  postgres_data: